<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="regCtsem">
<title>cpptsem • regCtsem</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="cpptsem">
<meta property="og:description" content="regCtsem">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">regCtsem</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/regCtsem.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/MatrixExponential.html">MatrixExponential</a>
    <a class="dropdown-item" href="../articles/cpptsem.html">cpptsem</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>cpptsem</h1>
            
      
      
      <div class="d-none name"><code>cpptsem.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="ctsem">c<sub>++</sub>tsem<a class="anchor" aria-label="anchor" href="#ctsem"></a>
</h2>
<p>regCtsem will try to internally translate any ctsem object passed to
the main function (regCtsem:::regCtsem) to a C++ object. The functions
for this C++ object are implemented following the naming scheme
c<sub>++</sub>tsem. The sole purpose of this translation is speeding up
the computation of the -2 log-Likelihood and an approximation of the
gradients for continuous time structural equation models. The
implementation closely follows that of ctsemOMX (Driver et al.,
2017).</p>
<p><strong>Known limitations</strong></p>
<ul>
<li>Time dependent predictors are not yet supported in
c<sub>++</sub>tsem.</li>
</ul>
<div class="section level3">
<h3 id="demonstration-of-main-functions">Demonstration of main functions<a class="anchor" aria-label="anchor" href="#demonstration-of-main-functions"></a>
</h3>
<p>To demonstrate the application of c<sub>++</sub>tsem, the example
from ctsem will be used.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cdriveraus/ctsemOMX" class="external-link">ctsemOMX</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">regCtsem</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set up model with ctsem</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"AnomAuth"</span><span class="op">)</span></span>
<span><span class="va">AnomAuthmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ctsem/man/ctModel.html" class="external-link">ctModel</a></span><span class="op">(</span>LAMBDA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>                         Tpoints <span class="op">=</span> <span class="fl">5</span>, n.latent <span class="op">=</span> <span class="fl">2</span>, n.manifest <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                         MANIFESTVAR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, TRAITVAR <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span>
<span><span class="co"># the optimizer will not used here because the gradients would otherwise </span></span>
<span><span class="co"># be very close to zero and the similarity between the OpenMx based </span></span>
<span><span class="co"># gradients and the cpptsem based gradients would be harder to see:</span></span>
<span><span class="va">AnomAuthfit</span> <span class="op">&lt;-</span> <span class="fu">ctFit</span><span class="op">(</span><span class="va">AnomAuth</span>, <span class="va">AnomAuthmodel</span>, useOptimizer <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> </span></code></pre></div>
<p>The general workflow with c<sub>++</sub>tsem when using the reticular
action model (RAM) is:</p>
<ol style="list-style-type: decimal">
<li>translate ctsem to c<sub>++</sub>tsem</li>
<li>computeRAM() computes the A, S, and M matrices as well as the
expected means and covariances</li>
<li>fitRAM() computes the -2log-likelihood</li>
<li>approxRAMGradients((1.1 * 10^(-16))^(1/3)) computes the
gradients</li>
</ol>
<p>The general workflow with c<sub>++</sub>tsem when using the Kalman
filter is:</p>
<ol style="list-style-type: decimal">
<li>translate ctsem to c<sub>++</sub>tsem</li>
<li>computeAndFitKalman(0) computes the predicted and updated latent
scores as well as the -2log-Likelihood. The number indicates for which
person the fit should be calculated: 0 = full sample, 1,…, N for
individual 1, …, N. The latent scores can be extracted with
$latentScores</li>
<li>approxKalmanGradients((1.1 * 10^(-16))^(1/3)) computes the
gradients</li>
</ol>
<p>This will be explained in more detail below using the RAM model.
Otherwise, more details can be found with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">cpptsemFromCtsem</span></span></code></pre></div>
<div class="section level4">
<h4 id="translate-ctsem-object-to-ctsem">Translate ctsem object to c<sub>++</sub>tsem<a class="anchor" aria-label="anchor" href="#translate-ctsem-object-to-ctsem"></a>
</h4>
<p>The function cpptsemFromCtsem translates a fitted ctsem object (e.g.,
AnomAuthfit in the example above) in a new object of class
Rcpp_cpptsemmodel:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpptsemmodel</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/cpptsemFromCtsem.html">cpptsemFromCtsem</a></span><span class="op">(</span><span class="va">AnomAuthfit</span>, wideData <span class="op">=</span> <span class="va">AnomAuth</span><span class="op">)</span></span>
<span><span class="co">#&gt; Translating model to C++. Found the following elements: T0MEANS, T0VARbase, DRIFT, DIFFUSIONbase, TRAITVARbase, T0TRAITEFFECT, CINT, MANIFESTMEANS, LAMBDA, MANIFESTVARbase.</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="compute-the-ram-matrices">Compute the RAM matrices<a class="anchor" aria-label="anchor" href="#compute-the-ram-matrices"></a>
</h4>
<p>Once the cpptsem object was created, the RAM matrices with discrete
time parameters can be obtained using the computeRAM() function. This
will compute the A matrix (directed effects), the S matrix (residual
covariances), and the M vector (means) as well as the expected means and
expected covariances.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">computeRAM</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The elements can be accessed with the $ operator:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="va">A</span></span>
<span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="va">S</span></span>
<span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="va">M</span></span>
<span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="cn">F</span></span>
<span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="va">expectedMeans</span></span>
<span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="va">expectedCovariance</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="compute-the--2-log-likelihood">Compute the -2 log likelihood<a class="anchor" aria-label="anchor" href="#compute-the--2-log-likelihood"></a>
</h4>
<p>The function fitRAM() computes the -2 log likelihood based on the
data and the expected means and covariances.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">fitRAM</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="va">m2LL</span></span>
<span><span class="co">#&gt; [1] 85751.19</span></span></code></pre></div>
<p>We can now compare this to the results from ctsem:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">mxobj</span><span class="op">$</span><span class="va">fitfunction</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 85751.19</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="finite-difference-derivative-approximation-of-the-gradients">Finite difference derivative approximation of the gradients<a class="anchor" aria-label="anchor" href="#finite-difference-derivative-approximation-of-the-gradients"></a>
</h4>
<p>The derivative of the likelihood with respect to the parameters is
computed based on finite differencing. The procedure is as follows:</p>
<p>For each parameter (1.1) take a minimal step forward (parameter +
epsilon), (1.2) compute the -2 log likelihood, (2.1) take a minimal step
backward (parameter - epsilon), (2.2) compute the -2 log likelihood, (3)
compute the difference in the likelihoods and divide by 2*epsilon.</p>
<p>This so-called central differencing is performed by the
approxRAMGradients function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpptsemGradients</span> <span class="op">&lt;-</span> <span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">approxRAMGradients</span><span class="op">(</span><span class="op">(</span><span class="fl">1.1</span> <span class="op">*</span> <span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co"># epsilon = (1.1 * 10^(-16))^(1/3) sets the precision of the numerical approximation. </span></span>
<span><span class="co"># Smaller numbers result in higher precision, but might also result in </span></span>
<span><span class="co"># errors due to the numerical precision of the computer. The value used here is recommended</span></span>
<span><span class="co"># in Nocedal, J., &amp; Wright, S. J. (2006). Numerical optimization (2nd ed). Springer. See p. 197.</span></span></code></pre></div>
<p>Again, the results can be compared to the values from OpenMx:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gradientModel</span> <span class="op">&lt;-</span> <span class="fu">OpenMx</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/mxRun.html" class="external-link">mxRun</a></span><span class="op">(</span><span class="fu">OpenMx</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/mxModel.html" class="external-link">mxModel</a></span><span class="op">(</span><span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">mxobj</span>,</span>
<span>                                               <span class="fu">OpenMx</span><span class="fu">::</span><span class="fu">mxComputeSequence</span><span class="op">(</span>steps<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                                                 <span class="fu">OpenMx</span><span class="fu">::</span><span class="fu">mxComputeNumericDeriv</span><span class="op">(</span></span>
<span>                                                   checkGradient <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                                   hessian <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>                                               <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ctsemGradients</span> <span class="op">&lt;-</span> <span class="va">gradientModel</span><span class="op">$</span><span class="va">compute</span><span class="op">$</span><span class="va">steps</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">output</span><span class="op">[[</span><span class="st">"gradient"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="st">"central"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ctsemGradients</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">gradientModel</span><span class="op">$</span><span class="va">compute</span><span class="op">$</span><span class="va">steps</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">output</span><span class="op">[[</span><span class="st">"gradient"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpptsemGradients</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ctsemGradients</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;           T0m_eta1           T0m_eta2         drift_eta1    drift_eta2_eta1 </span></span>
<span><span class="co">#&gt;         -81.658646        -199.382586        3745.502450        -500.009147 </span></span>
<span><span class="co">#&gt;    drift_eta1_eta2         drift_eta2          diff_eta1     diff_eta2_eta1 </span></span>
<span><span class="co">#&gt;        -442.563679        4452.624532        6890.000713         -19.562421 </span></span>
<span><span class="co">#&gt;          diff_eta2         T0var_eta1    T0var_eta2_eta1         T0var_eta2 </span></span>
<span><span class="co">#&gt;        8242.823336        4853.767173         -32.310510        4261.222762 </span></span>
<span><span class="co">#&gt;              mm_Y1              mm_Y2      traitvar_eta1 traitvar_eta2_eta1 </span></span>
<span><span class="co">#&gt;        -128.966651        -279.644755         571.607701          -8.718577 </span></span>
<span><span class="co">#&gt;      traitvar_eta2 </span></span>
<span><span class="co">#&gt;         503.418802</span></span>
<span><span class="va">ctsemGradients</span></span>
<span><span class="co">#&gt;           T0m_eta1           T0m_eta2         drift_eta1    drift_eta2_eta1 </span></span>
<span><span class="co">#&gt;         -81.658643        -199.382583        3745.502427        -500.009170 </span></span>
<span><span class="co">#&gt;    drift_eta1_eta2         drift_eta2          diff_eta1     diff_eta2_eta1 </span></span>
<span><span class="co">#&gt;        -442.563701        4452.624511        6890.000714         -19.562421 </span></span>
<span><span class="co">#&gt;          diff_eta2         T0var_eta1    T0var_eta2_eta1         T0var_eta2 </span></span>
<span><span class="co">#&gt;        8242.823337        4853.767172         -32.310508        4261.222764 </span></span>
<span><span class="co">#&gt;              mm_Y1              mm_Y2      traitvar_eta1 traitvar_eta2_eta1 </span></span>
<span><span class="co">#&gt;        -128.966651        -279.644750         571.607703          -8.718576 </span></span>
<span><span class="co">#&gt;      traitvar_eta2 </span></span>
<span><span class="co">#&gt;         503.418802</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="changing-parameter-values">Changing parameter values<a class="anchor" aria-label="anchor" href="#changing-parameter-values"></a>
</h4>
<p>Finally, setParameterValues() can be used to change the parameter
values of a cpptsem model.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># to have a second set of parameter values the ctsem model is fitted again.</span></span>
<span><span class="co"># However, this time the optimizer is used:</span></span>
<span><span class="va">AnomAuthfit2</span> <span class="op">&lt;-</span> <span class="fu">ctFit</span><span class="op">(</span><span class="va">AnomAuth</span>, <span class="va">AnomAuthmodel</span>, useOptimizer <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span>
<span><span class="co"># extract parameters:</span></span>
<span><span class="va">newParameters</span> <span class="op">&lt;-</span> <span class="fu">OpenMx</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/omxGetParameters.html" class="external-link">omxGetParameters</a></span><span class="op">(</span><span class="va">AnomAuthfit2</span><span class="op">$</span><span class="va">mxobj</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">setParameterValues</span><span class="op">(</span><span class="va">newParameters</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">newParameters</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">getParameterValues</span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">newParameters</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="application-example-1-time-differences-in-gradient-computation">Application Example 1: Time differences in gradient computation<a class="anchor" aria-label="anchor" href="#application-example-1-time-differences-in-gradient-computation"></a>
</h3>
<p>The main motivation for c<sub>++</sub>tsem was to have a faster way
to compute the gradients of a ctsem. This is only necessary in very
specific situations, however we found that when working with the
mxObject from ctsem computing just the gradients can be quite slow. The
reason for this might be that the model has to be set up every time we
computed the gradients. It is possible that there is a faster way to
compute the gradients with ctsem / OpenMx, but we couldn’t find it. In
the following a short demonstration of the time differences between my
approach with ctsem / OpenMx and the computation with c<sub>++</sub>tsem
is demonstrated:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cdriveraus/ctsemOMX" class="external-link">ctsemOMX</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">regCtsem</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">64356</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## define the population model:</span></span>
<span></span>
<span><span class="co"># set the drift matrix</span></span>
<span><span class="va">ct_drift</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.3</span>,<span class="fl">.2</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">.5</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">generatingModel</span><span class="op">&lt;-</span><span class="fu">ctsem</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ctsem/man/ctModel.html" class="external-link">ctModel</a></span><span class="op">(</span>Tpoints<span class="op">=</span><span class="fl">10</span>,n.latent<span class="op">=</span><span class="fl">2</span>,n.TDpred<span class="op">=</span><span class="fl">0</span>,n.TIpred<span class="op">=</span><span class="fl">0</span>,n.manifest<span class="op">=</span><span class="fl">2</span>,</span>
<span>                                MANIFESTVAR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                LAMBDA<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                DRIFT<span class="op">=</span><span class="va">ct_drift</span>,</span>
<span>                                DIFFUSION<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.5</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">.5</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                CINT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                                T0MEANS<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,ncol<span class="op">=</span><span class="fl">1</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                                T0VAR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"omx"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate a training data set</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">ctsem</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ctsem/man/ctGenerate.html" class="external-link">ctGenerate</a></span><span class="op">(</span><span class="va">generatingModel</span>,n.subjects <span class="op">=</span> <span class="fl">100</span>, wide <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Build the analysis model. </span></span>
<span><span class="va">myModel</span> <span class="op">&lt;-</span> <span class="fu">ctsem</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ctsem/man/ctModel.html" class="external-link">ctModel</a></span><span class="op">(</span>Tpoints<span class="op">=</span><span class="fl">10</span>,n.latent<span class="op">=</span><span class="fl">2</span>,n.TDpred<span class="op">=</span><span class="fl">0</span>,n.TIpred<span class="op">=</span><span class="fl">0</span>,n.manifest<span class="op">=</span><span class="fl">2</span>,</span>
<span>                          LAMBDA<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                          MANIFESTVAR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                          CINT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                          DIFFUSION<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'eta1_eta1'</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="st">'eta2_eta2'</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                          T0MEANS<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,ncol<span class="op">=</span><span class="fl">1</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                          T0VAR<span class="op">=</span><span class="st">"auto"</span>, type <span class="op">=</span> <span class="st">"omx"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit the model using ctsemOMX:</span></span>
<span><span class="va">fit_myModel</span> <span class="op">&lt;-</span> <span class="fu">ctsemOMX</span><span class="fu">::</span><span class="fu">ctFit</span><span class="op">(</span><span class="va">dat</span>, <span class="va">myModel</span><span class="op">)</span></span>
<span></span>
<span><span class="va">repetitions</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># set up the gradient model for ctsem / OpenMx</span></span>
<span></span>
<span><span class="va">gradientModel</span> <span class="op">&lt;-</span> <span class="fu">OpenMx</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/mxModel.html" class="external-link">mxModel</a></span><span class="op">(</span><span class="va">fit_myModel</span><span class="op">$</span><span class="va">mxobj</span>,</span>
<span>                                 <span class="fu">OpenMx</span><span class="fu">::</span><span class="fu">mxComputeSequence</span><span class="op">(</span>steps<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                                   <span class="fu">OpenMx</span><span class="fu">::</span><span class="fu">mxComputeNumericDeriv</span><span class="op">(</span></span>
<span>                                     checkGradient <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                     hessian <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>                                 <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set up the model for cpptsem</span></span>
<span><span class="va">cpptsemGradientDemonstation</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/cpptsemFromCtsem.html">cpptsemFromCtsem</a></span><span class="op">(</span><span class="va">fit_myModel</span>, wideData <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">cpptsemGradientDemonstation</span><span class="op">$</span><span class="fu">computeRAM</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cpptsemGradientDemonstation</span><span class="op">$</span><span class="fu">fitRAM</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">OpenMxStart</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">repetitions</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">gradientModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/mxRun.html" class="external-link">mxRun</a></span><span class="op">(</span><span class="va">gradientModel</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">OpenMxEnd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">CpptsemStart</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">repetitions</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">cpptsemGradients</span> <span class="op">&lt;-</span> <span class="va">cpptsemGradientDemonstation</span><span class="op">$</span><span class="fu">approxRAMGradients</span><span class="op">(</span><span class="op">(</span><span class="fl">1.1</span> <span class="op">*</span> <span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span><span class="va">CpptsemEnd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>For 100 repetitive computations of the gradients, ctsem / OpenMx took
20.6413757801056 seconds, while c<sub>++</sub>tsem took
0.186470031738281 seconds. Importantly this does <strong>not</strong>
mean that c<sub>++</sub>tsem is always faster! It is only faster in this
very specific application. The differences also tend to become smaller
with more missings in the data set. However c<sub>++</sub>tsem still
tends to outperform the ctsem / OpenMx approach by a factor of around
10.</p>
</div>
<div class="section level3">
<h3 id="application-example-2-general-purpose-optimizer-with-ram">Application Example 2: General purpose optimizer with RAM<a class="anchor" aria-label="anchor" href="#application-example-2-general-purpose-optimizer-with-ram"></a>
</h3>
<p>c<sub>++</sub>tsem can be used in general purpose optimizers such as
solnp or optim. In the following the use with optim is demonstrated:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cdriveraus/ctsemOMX" class="external-link">ctsemOMX</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">regCtsem</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set up model with ctsem</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"AnomAuth"</span><span class="op">)</span></span>
<span><span class="va">AAmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ctsem/man/ctModel.html" class="external-link">ctModel</a></span><span class="op">(</span>LAMBDA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>                   Tpoints <span class="op">=</span> <span class="fl">5</span>, n.latent <span class="op">=</span> <span class="fl">2</span>, n.manifest <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                   MANIFESTVAR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, TRAITVAR <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span>
<span><span class="co"># generate ctsem object, but don't optimize:</span></span>
<span><span class="va">AANotOptimized</span> <span class="op">&lt;-</span> <span class="fu">ctFit</span><span class="op">(</span><span class="va">AnomAuth</span>, <span class="va">AAmodel</span>, useOptimizer <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> </span>
<span><span class="co"># for later comparison: optimized ctsem object:</span></span>
<span><span class="va">AACtsemFit</span> <span class="op">&lt;-</span> <span class="fu">ctFit</span><span class="op">(</span><span class="va">AnomAuth</span>, <span class="va">AAmodel</span>, useOptimizer <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># translate to cpptsem:</span></span>
<span><span class="va">AACpptsem</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/cpptsemFromCtsem.html">cpptsemFromCtsem</a></span><span class="op">(</span><span class="va">AANotOptimized</span>, wideData <span class="op">=</span> <span class="va">AnomAuth</span><span class="op">)</span></span>
<span></span>
<span><span class="va">startingValues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/omxGetParameters.html" class="external-link">omxGetParameters</a></span><span class="op">(</span><span class="va">AANotOptimized</span><span class="op">$</span><span class="va">mxobj</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m2LLCpptsem</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">parameters</span>, <span class="va">cpptsemmodel</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">setParameterValues</span><span class="op">(</span><span class="va">parameters</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># catching all errors from cpptsemmodel </span></span>
<span>  <span class="co"># when parameter values are impossible</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="va">RAM</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">computeRAM</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                                      silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                           type <span class="op">=</span> <span class="st">"message"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="va">FIT</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">fitRAM</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                      silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                           type <span class="op">=</span> <span class="st">"message"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">RAM</span><span class="op">)</span> <span class="op">==</span> <span class="st">"try-error"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">FIT</span><span class="op">)</span> <span class="op">==</span> <span class="st">"try-error"</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="va">m2LL</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">gradCpptsem</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">parameters</span>, <span class="va">cpptsemmodel</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="va">grad</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">approxRAMGradients</span><span class="op">(</span><span class="op">(</span><span class="fl">1.1</span> <span class="op">*</span> <span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                                       silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                           type <span class="op">=</span> <span class="st">"message"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">grad</span><span class="op">)</span> <span class="op">==</span> <span class="st">"try-error"</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">grad</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># compute </span></span>
<span><span class="va">AACpptsemFit</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span>par <span class="op">=</span> <span class="va">startingValues</span>, </span>
<span>                      fn <span class="op">=</span> <span class="va">m2LLCpptsem</span>, </span>
<span>                      gr <span class="op">=</span> <span class="va">gradCpptsem</span>,  </span>
<span>                      <span class="va">AACpptsem</span>, </span>
<span>                      method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span></code></pre></div>
<p>Comparison of parameter estimates:</p>
<p><strong>ctsem</strong></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/omxGetParameters.html" class="external-link">omxGetParameters</a></span><span class="op">(</span><span class="va">AACtsemFit</span><span class="op">$</span><span class="va">mxobj</span><span class="op">)</span></span>
<span><span class="co">#&gt;           T0m_eta1           T0m_eta2         drift_eta1    drift_eta2_eta1 </span></span>
<span><span class="co">#&gt;       -0.187016954       -0.028472448       -2.480228865        0.045944318 </span></span>
<span><span class="co">#&gt;    drift_eta1_eta2         drift_eta2          diff_eta1     diff_eta2_eta1 </span></span>
<span><span class="co">#&gt;        0.272356174       -0.224282818        0.071472736        0.007714258 </span></span>
<span><span class="co">#&gt;          diff_eta2         T0var_eta1    T0var_eta2_eta1         T0var_eta2 </span></span>
<span><span class="co">#&gt;       -0.880949144       -0.669434040        0.049743273       -0.859045048 </span></span>
<span><span class="co">#&gt;              mm_Y1              mm_Y2      traitvar_eta1 traitvar_eta2_eta1 </span></span>
<span><span class="co">#&gt;        2.690368114        2.871194481       -0.468550052        0.355051374 </span></span>
<span><span class="co">#&gt;      traitvar_eta2 </span></span>
<span><span class="co">#&gt;       -0.947172540</span></span></code></pre></div>
<p><strong>c<sub>++</sub>tsem</strong></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AACpptsemFit</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="co">#&gt;           T0m_eta1           T0m_eta2         drift_eta1    drift_eta2_eta1 </span></span>
<span><span class="co">#&gt;       -0.187019747       -0.028470912       -2.480133756        0.045822393 </span></span>
<span><span class="co">#&gt;    drift_eta1_eta2         drift_eta2          diff_eta1     diff_eta2_eta1 </span></span>
<span><span class="co">#&gt;        0.272189556       -0.224275450        0.071455746        0.007747149 </span></span>
<span><span class="co">#&gt;          diff_eta2         T0var_eta1    T0var_eta2_eta1         T0var_eta2 </span></span>
<span><span class="co">#&gt;       -0.880944640       -0.669443190        0.049734737       -0.859053977 </span></span>
<span><span class="co">#&gt;              mm_Y1              mm_Y2      traitvar_eta1 traitvar_eta2_eta1 </span></span>
<span><span class="co">#&gt;        2.690371260        2.871192033       -0.468545422        0.355059365 </span></span>
<span><span class="co">#&gt;      traitvar_eta2 </span></span>
<span><span class="co">#&gt;       -0.947134280</span></span></code></pre></div>
<p>Comparison of fit:</p>
<p><strong>ctsem</strong></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ctsem:</span></span>
<span><span class="va">AACtsemFit</span><span class="op">$</span><span class="va">mxobj</span><span class="op">$</span><span class="va">fitfunction</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 22898.53</span></span></code></pre></div>
<p><strong>c<sub>++</sub>tsem</strong></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AACpptsemFit</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="co">#&gt; [1] 22898.53</span></span></code></pre></div>
<p><strong>A quick note on optimization</strong>: SEMs are quite
difficult to optimize because the objective function is not convex. In
my (very limited) experience with c<sub>++</sub>tsem and optim, I have
observed that sometimes the optim approach outperforms ctsem and
sometimes it’s the other way around. This seems to come down to
whichever of the two optimizers ends up in a bad spot due to local
minima.</p>
</div>
<div class="section level3">
<h3 id="application-example-3-general-purpose-optimizer-with-kalman-filter">Application Example 3: General purpose optimizer with Kalman
filter<a class="anchor" aria-label="anchor" href="#application-example-3-general-purpose-optimizer-with-kalman-filter"></a>
</h3>
<p>Similar to example 2, c<sub>++</sub>tsem can be used in general
purpose optimizers such as solnp or optim when using the Kalman filter.
In the following the use with solnp is demonstrated:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">regCtsem</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cdriveraus/ctsemOMX" class="external-link">ctsemOMX</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">175446</span><span class="op">)</span></span>
<span><span class="co">## define the population model:</span></span>
<span></span>
<span><span class="co"># set the drift matrix. Note that drift eta_1_eta2 is set to equal 0 in the population.</span></span>
<span><span class="va">ct_drift</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.3</span>,<span class="fl">.2</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">.5</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">generatingModel</span><span class="op">&lt;-</span><span class="fu">ctsem</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ctsem/man/ctModel.html" class="external-link">ctModel</a></span><span class="op">(</span>Tpoints<span class="op">=</span><span class="fl">20</span>,n.latent<span class="op">=</span><span class="fl">2</span>,n.TDpred<span class="op">=</span><span class="fl">0</span>,n.TIpred<span class="op">=</span><span class="fl">0</span>,n.manifest<span class="op">=</span><span class="fl">2</span>,</span>
<span>                                MANIFESTVAR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                LAMBDA<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                DRIFT<span class="op">=</span><span class="va">ct_drift</span>,</span>
<span>                                DIFFUSION<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.5</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">.5</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                CINT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                T0MEANS<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,ncol<span class="op">=</span><span class="fl">1</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                                T0VAR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"omx"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate a training data and testing data set</span></span>
<span><span class="va">traindata</span> <span class="op">&lt;-</span> <span class="fu">ctsem</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ctsem/man/ctGenerate.html" class="external-link">ctGenerate</a></span><span class="op">(</span><span class="va">generatingModel</span>,n.subjects <span class="op">=</span> <span class="fl">50</span>, wide <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Build the analysis model. Note that drift eta1_eta2 is freely estimated</span></span>
<span><span class="co"># although it is 0 in the population.</span></span>
<span><span class="va">kalmanModel</span> <span class="op">&lt;-</span> <span class="fu">ctsem</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ctsem/man/ctModel.html" class="external-link">ctModel</a></span><span class="op">(</span>Tpoints<span class="op">=</span><span class="fl">20</span>,n.latent<span class="op">=</span><span class="fl">2</span>,n.TDpred<span class="op">=</span><span class="fl">0</span>,n.TIpred<span class="op">=</span><span class="fl">0</span>,n.manifest<span class="op">=</span><span class="fl">2</span>,</span>
<span>                              LAMBDA<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                              MANIFESTVAR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                              CINT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                              DIFFUSION<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'eta1_eta1'</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="st">'eta2_eta2'</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                              T0MEANS<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,ncol<span class="op">=</span><span class="fl">1</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                              T0VAR<span class="op">=</span><span class="st">"auto"</span>, type <span class="op">=</span> <span class="st">"omx"</span><span class="op">)</span></span>
<span><span class="va">kalmanModelNotOptimized</span> <span class="op">&lt;-</span> <span class="fu">ctFit</span><span class="op">(</span><span class="va">kalmanModel</span>, dat <span class="op">=</span> <span class="va">traindata</span>, </span>
<span>                                 objective <span class="op">=</span> <span class="st">"Kalman"</span>, useOptimizer <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="co"># fitted model for later comparison:</span></span>
<span><span class="va">kalmanModelOptimized</span> <span class="op">&lt;-</span> <span class="fu">ctFit</span><span class="op">(</span><span class="va">kalmanModel</span>, dat <span class="op">=</span> <span class="va">traindata</span>, </span>
<span>                              objective <span class="op">=</span> <span class="st">"Kalman"</span>, useOptimizer <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">## with cpptsem</span></span>
<span><span class="va">kalmanCpptsemmodel</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/cpptsemFromCtsem.html">cpptsemFromCtsem</a></span><span class="op">(</span>ctsemModel <span class="op">=</span> <span class="va">kalmanModelNotOptimized</span>,</span>
<span>                                                 wideData <span class="op">=</span> <span class="va">traindata</span><span class="op">)</span></span>
<span></span>
<span><span class="va">startingValues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/omxGetParameters.html" class="external-link">omxGetParameters</a></span><span class="op">(</span><span class="va">kalmanModelNotOptimized</span><span class="op">$</span><span class="va">mxobj</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m2LLCpptsem</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">parameters</span>, <span class="va">cpptsemmodel</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">setParameterValues</span><span class="op">(</span><span class="va">parameters</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># catching all errors from cpptsemmodel </span></span>
<span>  <span class="co"># when parameter values are impossible</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="va">KALMAN</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="fu">computeAndFitKalman</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, </span>
<span>                                         silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                           type <span class="op">=</span> <span class="st">"message"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">KALMAN</span><span class="op">)</span> <span class="op">==</span> <span class="st">"try-error"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="va">m2LL</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">99999999</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">cpptsemmodel</span><span class="op">$</span><span class="va">m2LL</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># compute </span></span>
<span><span class="va">kalmanCpptsemFit</span> <span class="op">&lt;-</span> <span class="fu">Rsolnp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rsolnp/man/solnp.html" class="external-link">solnp</a></span><span class="op">(</span>pars <span class="op">=</span> <span class="va">startingValues</span>, </span>
<span>                                  fun <span class="op">=</span> <span class="va">m2LLCpptsem</span>, </span>
<span>                                  eqfun <span class="op">=</span> <span class="cn">NULL</span>, eqB <span class="op">=</span> <span class="cn">NULL</span>, ineqfun <span class="op">=</span> <span class="cn">NULL</span>, ineqLB <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                                  ineqUB <span class="op">=</span> <span class="cn">NULL</span>, LB <span class="op">=</span> <span class="cn">NULL</span>, UB <span class="op">=</span> <span class="cn">NULL</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                                  <span class="va">kalmanCpptsemmodel</span><span class="op">)</span></span></code></pre></div>
<p>Comparison of parameter estimates:</p>
<p><strong>ctsem</strong></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/omxGetParameters.html" class="external-link">omxGetParameters</a></span><span class="op">(</span><span class="va">kalmanModelOptimized</span><span class="op">$</span><span class="va">mxobj</span><span class="op">)</span></span>
<span><span class="co">#&gt;      drift_eta1 drift_eta2_eta1 drift_eta1_eta2      drift_eta2       eta1_eta1 </span></span>
<span><span class="co">#&gt;     -0.28179207      0.18633329      0.01358409     -0.47165193     -0.65454891 </span></span>
<span><span class="co">#&gt;       eta2_eta2      T0var_eta1 T0var_eta2_eta1      T0var_eta2           mm_Y1 </span></span>
<span><span class="co">#&gt;     -0.70071095     -0.15530510      0.07399650     -0.09844141      0.06861351 </span></span>
<span><span class="co">#&gt;           mm_Y2 </span></span>
<span><span class="co">#&gt;      0.04118951</span></span></code></pre></div>
<p><strong>c<sub>++</sub>tsem</strong></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kalmanCpptsemFit</span><span class="op">$</span><span class="va">pars</span></span>
<span><span class="co">#&gt;      drift_eta1 drift_eta2_eta1 drift_eta1_eta2      drift_eta2       eta1_eta1 </span></span>
<span><span class="co">#&gt;     -0.28179127      0.18633833      0.01358279     -0.47165845     -0.65454790 </span></span>
<span><span class="co">#&gt;       eta2_eta2      T0var_eta1 T0var_eta2_eta1      T0var_eta2           mm_Y1 </span></span>
<span><span class="co">#&gt;     -0.70070624     -0.15534835      0.07395015     -0.09844003      0.06861400 </span></span>
<span><span class="co">#&gt;           mm_Y2 </span></span>
<span><span class="co">#&gt;      0.04118876</span></span></code></pre></div>
<p>Comparison of fit:</p>
<p><strong>ctsem</strong></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ctsem:</span></span>
<span><span class="va">kalmanModelOptimized</span><span class="op">$</span><span class="va">mxobj</span><span class="op">$</span><span class="va">fitfunction</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 2410.442</span></span></code></pre></div>
<p><strong>c<sub>++</sub>tsem</strong></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kalmanCpptsemFit</span><span class="op">$</span><span class="va">values</span></span>
<span><span class="co">#&gt; [1] 12108.198  2410.442  2410.442</span></span></code></pre></div>
<p>When comparing the speed of optimizing the model using OpenMx and
c<sub>++</sub>tsem using solnp, the Kalman filter implementation in
c<sub>++</sub>tsem appears to be slightly faster:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu">Rsolnp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rsolnp/man/solnp.html" class="external-link">solnp</a></span><span class="op">(</span>pars <span class="op">=</span> <span class="va">startingValues</span>, </span>
<span>                                        fun <span class="op">=</span> <span class="va">m2LLCpptsem</span>, </span>
<span>                                        eqfun <span class="op">=</span> <span class="cn">NULL</span>, eqB <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                                        ineqfun <span class="op">=</span> <span class="cn">NULL</span>, ineqLB <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                                        ineqUB <span class="op">=</span> <span class="cn">NULL</span>, LB <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                                        UB <span class="op">=</span> <span class="cn">NULL</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                                        <span class="va">kalmanCpptsemmodel</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;  12.992  21.674   5.784</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/mxRun.html" class="external-link">mxRun</a></span><span class="op">(</span><span class="va">kalmanModelNotOptimized</span><span class="op">$</span><span class="va">mxobj</span>, </span>
<span>                                silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;  47.180   2.574   9.474</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="advanced-how-it-works">Advanced: How it works<a class="anchor" aria-label="anchor" href="#advanced-how-it-works"></a>
</h3>
<div class="section level4">
<h4 id="translation-from-ctsem">Translation from ctsem<a class="anchor" aria-label="anchor" href="#translation-from-ctsem"></a>
</h4>
<p>The cpptsemFromCtsem function automatically translates a fitted ctsem
model to c<sub>++</sub>tsem. In the following, the steps for doing so
are discussed in more detail.</p>
<div class="section level5">
<h5 id="step-1-extract-data">Step 1: Extract data<a class="anchor" aria-label="anchor" href="#step-1-extract-data"></a>
</h5>
<div class="section level6">
<h6 id="ram">RAM:<a class="anchor" aria-label="anchor" href="#ram"></a>
</h6>
<p>First, the constructDataset function will separate observations from
discrete time intervals. It will also identify unique missingness
patterns. In the next step, prepareRAMData will group individuals with
identical missingness patterns in subsamples. These subsamples will
later be used by fitRAM() to speed up the likelihood computation.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataInformation</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/constructDataset.html">constructDataset</a></span><span class="op">(</span>wideData <span class="op">=</span> <span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">mxobj</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span></span>
<span><span class="va">dataForRAM</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/prepareRAMData.html">prepareRAMData</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="va">dataInformation</span><span class="op">$</span><span class="va">dataset</span>,</span>
<span>                                       individualMissingPatternID <span class="op">=</span> <span class="va">dataInformation</span><span class="op">$</span><span class="va">individualMissingPatternID</span>,</span>
<span>                                       uniqueMissingPatterns <span class="op">=</span> <span class="va">dataInformation</span><span class="op">$</span><span class="va">uniqueMissingPatterns</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level6">
<h6 id="kalman">Kalman:<a class="anchor" aria-label="anchor" href="#kalman"></a>
</h6>
<p>For the Kalman filter, the functions are constructDataset and
prepareKalmanData. In contrast to prepareRAMData, prepareKalmanData will
not identify unique missingness patterns, as this will not speed up the
computation.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataInformation</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/constructDataset.html">constructDataset</a></span><span class="op">(</span>wideData <span class="op">=</span> <span class="va">wideData</span><span class="op">)</span></span>
<span><span class="va">dataForKalman</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/prepareKalmanData.html">prepareKalmanData</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="va">dataInformation</span><span class="op">$</span><span class="va">dataset</span>,</span>
<span>                                             nlatent <span class="op">=</span> <span class="va">nlatent</span>, nmanifest <span class="op">=</span> <span class="va">nmanifest</span>,</span>
<span>                                             dtIndicators <span class="op">=</span> <span class="va">dataInformation</span><span class="op">$</span><span class="va">dtIndicators</span>,</span>
<span>                                             Tpoints <span class="op">=</span> <span class="va">Tpoints</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level6">
<h6 id="limitations">Limitations<a class="anchor" aria-label="anchor" href="#limitations"></a>
</h6>
<p>In ctsem datasets it is possible to have different time intervals
within a single column:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"Oscillating"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Oscillating</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"dT"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Oscillating</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    dT1  dT2  dT3  dT4  dT5  dT6  dT7  dT8  dT9 dT10</span></span>
<span><span class="co">#&gt; 1 0.55 0.32 0.36 0.34 0.40 0.32 0.30 0.29 0.34 0.32</span></span>
<span><span class="co">#&gt; 2 0.56 0.42 0.34 0.38 0.43 0.47 0.44 0.52 0.42 0.38</span></span>
<span><span class="co">#&gt; 3 0.46 0.50 0.37 0.34 0.46 0.34 0.50 0.36 0.34 0.46</span></span>
<span><span class="co">#&gt; 4 0.50 0.35 0.29 0.42 0.44 0.57 0.43 0.38 0.57 0.42</span></span>
<span><span class="co">#&gt; 5 0.37 0.40 0.33 0.39 0.36 0.35 0.20 0.44 0.50 0.45</span></span>
<span><span class="co">#&gt; 6 0.46 0.35 0.35 0.43 0.44 0.49 0.44 0.37 0.51 0.36</span></span></code></pre></div>
<p>At the moment, c<sub>++</sub>tsem only supports this data format when
using the Kalman filter. In RAM models time intervals in the data set
have to be the same for all individuals. However, individually varying
time intervals of observations are allwed by means of missingness. For
instance, in the AnomAuth data set individual 6 has missings between
observations to account for individually differing time intervals:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">AnomAuth</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Y1_T0 Y2_T0 Y1_T1 Y2_T1 Y1_T2 Y2_T2 Y1_T3 Y2_T3 Y1_T4 Y2_T4 dT1 dT2 dT3 dT4</span></span>
<span><span class="co">#&gt; 1  2.67  3.50  3.33   3.5    NA    NA    NA    NA    NA    NA   1   1   2   2</span></span>
<span><span class="co">#&gt; 2  3.33  3.25    NA    NA    NA    NA    NA    NA    NA    NA   1   1   2   2</span></span>
<span><span class="co">#&gt; 3  3.33  2.75  3.33   3.0  3.33   2.5  2.33     3  2.33     3   1   1   2   2</span></span>
<span><span class="co">#&gt; 4  3.33  3.25    NA    NA    NA    NA    NA    NA    NA    NA   1   1   2   2</span></span>
<span><span class="co">#&gt; 5  4.00  4.00    NA    NA    NA    NA    NA    NA    NA    NA   1   1   2   2</span></span>
<span><span class="co">#&gt; 6  3.67  4.00    NA    NA    NA    NA  4.00     4  4.00     4   1   1   2   2</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level4">
<h4 id="step-2-extract-continuous-time-matrices">Step 2: Extract continuous time matrices<a class="anchor" aria-label="anchor" href="#step-2-extract-continuous-time-matrices"></a>
</h4>
<p>The function extractCtsemMatrices searches for the typical matrices
of a ctsem. These are (see ctsem for more details):</p>
<p>For the latent part:</p>
<ul>
<li>T0MEANS</li>
<li>T0VARbase</li>
<li>DRIFT</li>
<li>DIFFUSIONbase</li>
<li>TRAITVARbase</li>
<li>T0TRAITEFFECT</li>
<li>CINT</li>
</ul>
<p>For the manifest part:</p>
<ul>
<li>MANIFESTMEANS</li>
<li>LAMBDA</li>
<li>MANIFESTVARbase</li>
</ul>
<p>Note that time dependent predictors are currently not supported. For
each of these matrices, c<sub>++</sub>tsem saves the values and the
parameter names. For example:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctMatrices</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/extractCtsemMatrices.html">extractCtsemMatrices</a></span><span class="op">(</span><span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">mxobj</span>, </span>
<span>                                             <span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">ctmodelobj</span><span class="op">$</span><span class="va">n.latent</span>,</span>
<span>                                             <span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">ctmodelobj</span><span class="op">$</span><span class="va">n.manifest</span><span class="op">)</span></span>
<span><span class="co">#&gt; Translating model to C++. Found the following elements: T0MEANS, T0VARbase, DRIFT, DIFFUSIONbase, TRAITVARbase, T0TRAITEFFECT, CINT, MANIFESTMEANS, LAMBDA, MANIFESTVARbase.</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctMatrices</span><span class="op">$</span><span class="va">DRIFT</span></span>
<span><span class="co">#&gt; $values</span></span>
<span><span class="co">#&gt;       [,1]  [,2]</span></span>
<span><span class="co">#&gt; [1,] -0.45 -0.05</span></span>
<span><span class="co">#&gt; [2,] -0.05 -0.45</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $names</span></span>
<span><span class="co">#&gt;      [,1]              [,2]             </span></span>
<span><span class="co">#&gt; [1,] "drift_eta1"      "drift_eta1_eta2"</span></span>
<span><span class="co">#&gt; [2,] "drift_eta2_eta1" "drift_eta2"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="step-3-extract-parameter-table">Step 3: Extract parameter table<a class="anchor" aria-label="anchor" href="#step-3-extract-parameter-table"></a>
</h4>
<p>The most important part of c<sub>++</sub>tsem is the option to change
the parameter values. To this end, c<sub>++</sub>tsem uses the parameter
table which can be extracted from the mxobj of a ctsem:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">OpenMx</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/OpenMx/man/omxLocateParameters.html" class="external-link">omxLocateParameters</a></span><span class="op">(</span><span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">mxobj</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 label model        matrix row col     value lbound ubound</span></span>
<span><span class="co">#&gt; 1           diff_eta1 ctsem DIFFUSIONbase   1   1  2.302584     NA     NA</span></span>
<span><span class="co">#&gt; 2           diff_eta2 ctsem DIFFUSIONbase   2   2  2.302584     NA     NA</span></span>
<span><span class="co">#&gt; 3      diff_eta2_eta1 ctsem DIFFUSIONbase   2   1  0.100000     NA     NA</span></span>
<span><span class="co">#&gt; 4          drift_eta1 ctsem         DRIFT   1   1 -0.450000     NA     NA</span></span>
<span><span class="co">#&gt; 5     drift_eta1_eta2 ctsem         DRIFT   1   2 -0.050000     NA     NA</span></span>
<span><span class="co">#&gt; 6          drift_eta2 ctsem         DRIFT   2   2 -0.450000     NA     NA</span></span>
<span><span class="co">#&gt; 7     drift_eta2_eta1 ctsem         DRIFT   2   1 -0.050000     NA     NA</span></span>
<span><span class="co">#&gt; 8               mm_Y1 ctsem MANIFESTMEANS   1   1  0.861000     NA     NA</span></span>
<span><span class="co">#&gt; 9               mm_Y2 ctsem MANIFESTMEANS   2   1 -0.342000     NA     NA</span></span>
<span><span class="co">#&gt; 10           T0m_eta1 ctsem       T0MEANS   1   1 -0.123000     NA     NA</span></span>
<span><span class="co">#&gt; 11           T0m_eta2 ctsem       T0MEANS   2   1 -0.963000     NA     NA</span></span>
<span><span class="co">#&gt; 12         T0var_eta1 ctsem     T0VARbase   1   1  2.302585     NA     NA</span></span>
<span><span class="co">#&gt; 13         T0var_eta2 ctsem     T0VARbase   2   2  2.302585     NA     NA</span></span>
<span><span class="co">#&gt; 14    T0var_eta2_eta1 ctsem     T0VARbase   2   1  0.100000     NA     NA</span></span>
<span><span class="co">#&gt; 15      traitvar_eta1 ctsem  TRAITVARbase   1   1  1.098612     NA     NA</span></span>
<span><span class="co">#&gt; 16      traitvar_eta2 ctsem  TRAITVARbase   2   2  1.098612     NA     NA</span></span>
<span><span class="co">#&gt; 17 traitvar_eta2_eta1 ctsem  TRAITVARbase   2   1  0.100000     NA     NA</span></span></code></pre></div>
<p>Note that the <strong>matrix</strong> column in this table tells us
in which of the ctMatrices a parameter value belongs including a
specification of the row and column in this matrix. Similar to OpenMx,
c<sub>++</sub>tsem uses this information to change the parameter values.
As demonstrated above, this can be done with the setParameterValues()
function.</p>
<div class="section level5">
<h5 id="limiation">Limiation<a class="anchor" aria-label="anchor" href="#limiation"></a>
</h5>
<p>Lower and upper bounds for parameters are currently not
supported!</p>
</div>
</div>
<div class="section level4">
<h4 id="step-4-1-prepare-ram-matrices">Step 4-1: Prepare RAM matrices<a class="anchor" aria-label="anchor" href="#step-4-1-prepare-ram-matrices"></a>
</h4>
<p>Now that the parameter values and their location in ctMatrices are
known, the next step is to relate the continuous time parameters to the
data using structural equation models. The following matrices are
required:</p>
<ul>
<li>the <strong>A</strong> matrix holds the directed effects between
manifest and latent variables</li>
<li>the <strong>S</strong> matrix holds (residual) covariances between
manifest and latent variables</li>
<li>the <strong>M</strong> vector holds the intercepts</li>
<li>the <strong>F</strong> matrix separates manifest and latent
variables</li>
</ul>
<p>These matrices are generated with the prepareAMatrix, prepareSMatrix,
and prepareMMatrix functions. The F matrix is directly exported from
ctsem. In the following, the prepareAMatrix function will be used as an
example; prepareSMatrix, prepareMMatrix work similarly.</p>
<p>The prepareAMatrix function returns a list with 4-5 objects
(depending on the model). In our AnomAuthfit example, these are:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mxObject</span>  <span class="op">&lt;-</span> <span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">mxobj</span></span>
<span><span class="va">dataInformation</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/constructDataset.html">constructDataset</a></span><span class="op">(</span>wideData <span class="op">=</span> <span class="va">mxObject</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span></span>
<span><span class="va">Amatrix</span> <span class="op">&lt;-</span> <span class="fu">regCtsem</span><span class="fu">:::</span><span class="fu"><a href="../reference/prepareAMatrix.html">prepareAMatrix</a></span><span class="op">(</span>mxObject <span class="op">=</span> <span class="va">mxObject</span>, </span>
<span>                                    ctMatrices <span class="op">=</span> <span class="va">ctMatrices</span>, </span>
<span>                                    nlatent <span class="op">=</span> <span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">ctmodelobj</span><span class="op">$</span><span class="va">n.latent</span>, </span>
<span>                                    nmanifest <span class="op">=</span> <span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">ctmodelobj</span><span class="op">$</span><span class="va">n.manifest</span>,</span>
<span>                                    Tpoints <span class="op">=</span> <span class="va">AnomAuthfit</span><span class="op">$</span><span class="va">ctmodelobj</span><span class="op">$</span><span class="va">Tpoints</span>, </span>
<span>                                    dT <span class="op">=</span> <span class="va">dataInformation</span><span class="op">$</span><span class="va">dT</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Amatrix</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "discreteDRIFTUnique"     "discreteTRAITUnique"    </span></span>
<span><span class="co">#&gt; [3] "AParameterIndicators"    "cppAParameterIndicators"</span></span>
<span><span class="co">#&gt; [5] "AInitializer"</span></span></code></pre></div>
<p><strong>cppAParameterIndicators</strong> is a data frame similar to
the parameter table explained before. However, there is one important
distinction: The cppAParameterIndicators matrix shows how to put the
<em>discrete time parameters</em> in the A matrix:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Amatrix</span><span class="op">$</span><span class="va">cppAParameterIndicators</span></span>
<span><span class="co">#&gt;              label row_start row_end col_start col_end</span></span>
<span><span class="co">#&gt; 1  discreteDRIFT_1         2       3         0       1</span></span>
<span><span class="co">#&gt; 2  discreteDRIFT_1         4       5         2       3</span></span>
<span><span class="co">#&gt; 3  discreteDRIFT_2         6       7         4       5</span></span>
<span><span class="co">#&gt; 4  discreteDRIFT_2         8       9         6       7</span></span>
<span><span class="co">#&gt; 5  discreteTRAIT_1         2       3        10      11</span></span>
<span><span class="co">#&gt; 6  discreteTRAIT_1         4       5        10      11</span></span>
<span><span class="co">#&gt; 7  discreteTRAIT_2         6       7        10      11</span></span>
<span><span class="co">#&gt; 8  discreteTRAIT_2         8       9        10      11</span></span>
<span><span class="co">#&gt; 9           LAMBDA        12      13         0       1</span></span>
<span><span class="co">#&gt; 10          LAMBDA        14      15         2       3</span></span>
<span><span class="co">#&gt; 11          LAMBDA        16      17         4       5</span></span>
<span><span class="co">#&gt; 12          LAMBDA        18      19         6       7</span></span>
<span><span class="co">#&gt; 13          LAMBDA        20      21         8       9</span></span></code></pre></div>
<p>The labels column shows the names of the discrete time matrices. For
instance, discreteDRIFT_1 refers to the discrete time drift values for
the unique time interval 1. That is, when extracting the data from
ctsem, c<sub>++</sub>tsem automtically locates repeated time intervals
and computes the corresponding discrete time parameters just once. The
rest of the columns indicate the location of discreteDRIFT_1 in the A
matrix. <strong>Important</strong>: Subsetting matrices in C++ is
slightly different from R. In R mymatrix[1,1] accesses the element in
row 1, column 1 of mymatrix. However, in C++ counting starts with 0.
Therefore mymatrix[0,0] accesses the element in row 1, column 1 of
mymatrix. This is why prepareAMatrix returns an AParameterIndicators and
a cppAParameterIndicators object.</p>
<p><strong>discreteDRIFTUnique</strong> is a list which is best
explained by first looking at it:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Amatrix</span><span class="op">$</span><span class="va">discreteDRIFTUnique</span></span>
<span><span class="co">#&gt; $labels</span></span>
<span><span class="co">#&gt; [1] "discreteDRIFT_1" "discreteDRIFT_2"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dT</span></span>
<span><span class="co">#&gt; [1] 1 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $discreteDRIFT_1</span></span>
<span><span class="co">#&gt;      [,1] [,2]</span></span>
<span><span class="co">#&gt; [1,]    0    0</span></span>
<span><span class="co">#&gt; [2,]    0    0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $discreteDRIFT_2</span></span>
<span><span class="co">#&gt;      [,1] [,2]</span></span>
<span><span class="co">#&gt; [1,]    0    0</span></span>
<span><span class="co">#&gt; [2,]    0    0</span></span></code></pre></div>
<p>The labels correspond to the unique discrete drift labels in the
cppAParameterIndicators data frame shown before. dT refers to the
discrete time interval of the discrete drift. Finally, there is a matrix
for each of the unique discrete drifts where the results will be
stored.</p>
<p><strong>discreteTRAITUnique</strong> works similarly to
discreteDRIFTUnique. The cppAParameterIndicators data frame also
indicates the position of LAMBDA in the A matrix. As LAMBDA can be
directly exported from the ctMatrices object and requires no prior
computaion, there is no discreteLAMBDAUnique object.</p>
<p>Finally, <strong>AInitializer</strong> is a matrix of the same size
as the A matrix. Here c<sub>++</sub>tsem simply uses the A matrix from
the mxObject as a starting point.</p>
</div>
<div class="section level4">
<h4 id="step-4-2-prepare-kalman-matrices">Step 4-2: Prepare Kalman matrices<a class="anchor" aria-label="anchor" href="#step-4-2-prepare-kalman-matrices"></a>
</h4>
<p>In the first step, the discrete time elements (e.g.,
discreteDRIFTUnique) are generated using the prepareDiscreteElements
function. In contrast to the RAM specification, there is no need for an
A, S, M or F matrix. The discrete time elements work as described in the
previus section. The function prepareDiscreteElementNames simlply
generates for each discrete time element a string vector with as many
elements as there are time intervals indicating which of the unique
discrete time parameters to use (e.g. dT = c(1, 2, 1, 1) results in
discreteDRIFT_1, discreteDRIFT_2, discreteDRIFT_1, discreteDRIFT_1).</p>
<p>Finally, prepareKalmanMatrices initializes a matrix for the latent
scores and for the predicted manifest values.</p>
</div>
<div class="section level4">
<h4 id="step-5-1-computeram">Step 5-1: computeRAM<a class="anchor" aria-label="anchor" href="#step-5-1-computeram"></a>
</h4>
<p>When calling computeRAM(), c<sub>++</sub>tsem will:</p>
<ol style="list-style-type: decimal">
<li>extract the continuous time matrices from ctMatrices</li>
<li>compute all discrete time parameters (e.g.,
discreteDRIFTUnique)</li>
<li>fill the A, S, and M matrix with the discrete time parameters as
well as LAMBDA, T0MEANS, … using the cppAParameterIndicators,
cppMParameterIndicators, cppSParameterIndicators</li>
<li>compute the expected means and covariancs</li>
</ol>
</div>
<div class="section level4">
<h4 id="step-5-2-fitram">Step 5-2: fitRAM<a class="anchor" aria-label="anchor" href="#step-5-2-fitram"></a>
</h4>
<p><strong>NOTE</strong>: Github does not support mathematical
equations. To properly format the equations, compy them in an RMarkdown
file or in LaTeX.</p>
<p>When calling fitRAM(), c<sub>++</sub>tsem will compute the -2 log
likelihood. To this end it will iterate through the subsamples with
identical missingness patterns which were identified by prepareRAMData()
(see above).</p>
<p>If there is only a single person in the subsample, the -2 log
likelihood for this sample is given by:</p>
<p><span class="math display">\[-2\ln\mathcal{L}(\mathbf{x}_i) =
k_i\ln(2\pi)+\ln(|\boldsymbol\Sigma_i|)+(\mathbf{x}_i-\boldsymbol\mu_i)^T\boldsymbol\Sigma^{-1}_i(\mathbf{x}_i-\boldsymbol\mu_i)\]</span>
where <span class="math inline">\(i\)</span> refers to the person, <span class="math inline">\(k_i\)</span> is the number of non-missing
observations for this person, <span class="math inline">\(\boldsymbol
\Sigma_i\)</span> is the filtered expected covariance matrix (all rows
and columns for which no data is available from person i are removed)
and <span class="math inline">\(\mu_i\)</span> is the filtered expected
means vector (similar to filtered covariance).</p>
<p>If there are multiple persons in the subset, the simplified
likelihood function will be used. This is a trick which is used in
OpenMx extensively to speed up the full information maximum likelihood
estimation considerably:</p>
<p><span class="math display">\[\begin{aligned}
-2\ln\mathcal{L}(\mathbf D_g) =
N_gk_g\ln(2\pi)+N_g\ln(|\boldsymbol\Sigma_g|)+ N_g\text{tr}(\mathbf
S_g\boldsymbol\Sigma^{-1}_g)+ N_g(\bar{\mathbf
x}-\boldsymbol\mu)^T\boldsymbol\Sigma^{-1}_g(\bar{\mathbf
x}_g-\boldsymbol\mu_g)
\end{aligned}\]</span></p>
<p>where <span class="math inline">\(g\)</span> stands for the subset
<span class="math inline">\(g\)</span>, <span class="math inline">\(N_g\)</span> is the sample size of said subset,
<span class="math inline">\(k_g\)</span> the number of non-missing
observations for a person in subset <span class="math inline">\(g\)</span>, <span class="math inline">\(\boldsymbol \Sigma_g\)</span> denotes the filtered
expected covariance matrix and <span class="math inline">\(\mu_g\)</span> the filtered expected means vector.
Finally, <span class="math inline">\(\mathbf S_g = \frac{1}{N_g}\sum_{i
\in g}(\mathbf{x}_i-\bar{\mathbf x}_g)(\mathbf{x_i}-\bar{\mathbf
x}_g)^T\)</span> and <span class="math inline">\(\bar{\mathbf
x}_g\)</span> is the empirical mean vector of subsample g.</p>
<p>Finally, the -2log-Likelihoods of all subsamples are summed up and
returned.</p>
</div>
<div class="section level4">
<h4 id="step-5-3-computeandfitkalman">Step 5-3: computeAndFitKalman<a class="anchor" aria-label="anchor" href="#step-5-3-computeandfitkalman"></a>
</h4>
<p>For each person, the latent scores and latent state residual
covariances are first predicted and the updated. Furthermore, the
manifest values and manifest residual covariances are predicted from the
latent scores. These predictions are then used in the single subject -2
log likelihood function described in the previous equation. For more
information on the Kalman filter procedure see Welch, G., &amp; Bishop,
G. (2006). An Introduction to the Kalman Filter (Technical Report
No. 95–041). <a href="https://perso.crans.org/club-krobot/doc/kalman.pdf" class="external-link uri">https://perso.crans.org/club-krobot/doc/kalman.pdf</a> .</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="bibliography">Bibliography<a class="anchor" aria-label="anchor" href="#bibliography"></a>
</h2>
<ul>
<li>Boker, S. M., Neale, M. C., Maes, H. H., Wilde, M. J., Spiegel, M.,
Brick, T. R., Estabrook, R., Bates, T. C., &amp; Mehta, P. (2022).
OpenMx: Extended Structural Equation Modelling (2.20.0) [Computer
software]. <a href="https://cran.r-project.org/web/packages/OpenMx/OpenMx.pdf" class="external-link uri">https://cran.r-project.org/web/packages/OpenMx/OpenMx.pdf</a>
</li>
<li>Driver, C. C., Oud, J. H. L., &amp; Voelkle, M. C. (2017).
Continuous Time Structural Equation Modelling With R Package ctsem.
Journal of Statistical Software, 77(5), 1–36. <a href="https://doi.org/10.18637/jss.v077.i05" class="external-link uri">https://doi.org/10.18637/jss.v077.i05</a>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by .</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
